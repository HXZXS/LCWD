<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€Â·æ‰“å¡ # v.1.26</title>
    <style>
        :root {
            --primary: #4361ee;
            --success: #3f37c9;
            --warning: #f72585;
            --info: #4cc9f0;
            --light: #f8f9fa;
            --dark: #2d3748;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* 8ç§æ¸å˜èƒŒæ™¯è‰²å®šä¹‰ */
            --gradient-red: linear-gradient(135deg, rgba(229, 62, 62, 0.08), rgba(185, 28, 28, 0.05));
            --gradient-orange: linear-gradient(135deg, rgba(237, 137, 54, 0.08), rgba(194, 65, 12, 0.05));
            --gradient-green: linear-gradient(135deg, rgba(72, 187, 120, 0.08), rgba(21, 128, 61, 0.05));
            --gradient-blue: linear-gradient(135deg, rgba(66, 153, 225, 0.08), rgba(37, 99, 235, 0.05));
            --gradient-purple: linear-gradient(135deg, rgba(159, 122, 234, 0.08), rgba(109, 40, 217, 0.05));
            --gradient-pink: linear-gradient(135deg, rgba(236, 72, 153, 0.08), rgba(192, 38, 211, 0.05));
            --gradient-teal: linear-gradient(135deg, rgba(20, 184, 166, 0.08), rgba(13, 148, 136, 0.05));
            --gradient-indigo: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(67, 56, 202, 0.05));
            
            /* çº¯è‰²å¯¹åº” */
            --color-red: #e53e3e;
            --color-orange: #ed8936;
            --color-green: #48bb78;
            --color-blue: #4299e1;
            --color-purple: #9f7aea;
            --color-pink: #ec4899;
            --color-teal: #14b8a6;
            --color-indigo: #6366f1;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft YaHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4eaf5 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            overflow-x: hidden;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            border-radius: var(--radius); 
            padding: 30px; 
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, var(--primary), var(--success), var(--warning));
        }
        h1 { 
            text-align: center; 
            color: var(--primary); 
            margin-bottom: 8px; 
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .subtitle {
            text-align: center;
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 15px;
        }
        /* é¡¶éƒ¨æ¨ªå¹…é€šçŸ¥æ  */
        .top-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, var(--warning), #ff6b9d);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-size: 14px;
            z-index: 3000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .top-banner.show {
            transform: translateY(0);
        }
        .top-banner.env-warning {
            background: linear-gradient(90deg, #ed8936, #f6ad55);
        }
        .top-banner.activation-banner {
            background: linear-gradient(90deg, var(--primary), var(--success));
        }
        .banner-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
        }
        .banner-close:hover {
            background: rgba(255,255,255,0.3);
        }
        .banner-action {
            background: white;
            color: var(--warning);
            border: none;
            padding: 4px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
        }
        .banner-action:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
            flex-wrap: wrap;
            gap: 15px;
        }
        .date-time {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .date-box, .time-box {
            background: var(--light);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
        }
        .date-icon, .time-icon {
            color: var(--primary);
            margin-right: 6px;
            font-size: 16px;
        }
        .add-task-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(63, 55, 201, 0.2);
        }
        .add-task-btn:hover {
            background: #342da3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(63, 55, 201, 0.3);
        }
        .add-task-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        /* å½“å‰ä»»åŠ¡å¡ç‰‡ - å‘¼å¸ç¯æ•ˆæœ */
        .current-task-card {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.08), rgba(63, 55, 201, 0.08));
            border-radius: var(--radius);
            padding: 20px 24px;
            margin-bottom: 25px;
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            position: relative;
            overflow: hidden;
            animation: pulse-border 2s ease-in-out infinite;
        }
        @keyframes pulse-border {
            0%, 100% { 
                border-left-color: var(--primary);
                box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.1);
            }
            50% { 
                border-left-color: var(--success);
                box-shadow: 0 0 20px 5px rgba(67, 97, 238, 0.15);
            }
        }
        .current-task-card.active-task {
            background: linear-gradient(135deg, rgba(247, 37, 133, 0.08), rgba(255, 107, 157, 0.08));
            border-left-color: var(--warning);
            animation: pulse-active 2s ease-in-out infinite;
        }
        @keyframes pulse-active {
            0%, 100% { 
                border-left-color: var(--warning);
                box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.1);
            }
            50% { 
                border-left-color: #ff6b9d;
                box-shadow: 0 0 25px 8px rgba(247, 37, 133, 0.2);
            }
        }
        .task-icon {
            color: var(--primary);
            font-size: 24px;
            flex-shrink: 0;
            animation: bounce 2s ease-in-out infinite;
        }
        .current-task-card.active-task .task-icon {
            color: var(--warning);
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .current-task-text {
            font-size: 16px;
            font-weight: 500;
            flex: 1;
            min-width: 200px;
        }
        .current-task-text .task-name-highlight {
            color: var(--success);
            font-weight: 700;
            font-size: 18px;
        }
        .current-task-card.active-task .task-name-highlight {
            color: var(--warning);
        }
        .countdown-badge {
            background: var(--warning);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 10px;
            animation: pulse-badge 1.5s ease-in-out infinite;
        }
        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .free-time-suggestions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .suggestion-tag {
            background: rgba(72, 187, 120, 0.1);
            color: var(--color-green);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            border: 1px solid rgba(72, 187, 120, 0.2);
        }
        .tabs { 
            display: flex; 
            border-bottom: 1px solid var(--light-gray); 
            margin-bottom: 25px;
            position: relative;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar {
            display: none;
        }
        .tab { 
            padding: 12px 25px; 
            cursor: pointer; 
            border-bottom: 3px solid transparent;
            font-weight: 500;
            font-size: 16px;
            transition: var(--transition);
            color: var(--gray);
            white-space: nowrap;
        }
        .tab.active { 
            border-bottom: 3px solid var(--primary); 
            color: var(--primary);
        }
        .tab:hover:not(.active) {
            color: var(--dark);
            background: rgba(67, 97, 238, 0.03);
        }
        .tab-content { display: none; }
        .tab-content.active { 
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .task-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 16px;
            margin-bottom: 30px;
        }
        .task-item { 
            background: white; 
            padding: 20px; 
            border-radius: var(--radius); 
            border: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            gap: 15px;
            /* é»˜è®¤æ¸å˜èƒŒæ™¯ */
            background: var(--gradient-blue);
            touch-action: pan-y;
            user-select: none;
        }
        /* å¡ç‰‡æ¸å˜èƒŒæ™¯ç±» */
        .task-item.color-red { background: var(--gradient-red); }
        .task-item.color-orange { background: var(--gradient-orange); }
        .task-item.color-green { background: var(--gradient-green); }
        .task-item.color-blue { background: var(--gradient-blue); }
        .task-item.color-purple { background: var(--gradient-purple); }
        .task-item.color-pink { background: var(--gradient-pink); }
        .task-item.color-teal { background: var(--gradient-teal); }
        .task-item.color-indigo { background: var(--gradient-indigo); }
        
        /* å³ä¾§é¢œè‰²æ¡æ”¹ä¸ºå¡ç‰‡é€‰æ‹©è‰² */
        .task-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            transition: var(--transition);
        }
        .task-item.color-red::before { background: var(--color-red); }
        .task-item.color-orange::before { background: var(--color-orange); }
        .task-item.color-green::before { background: var(--color-green); }
        .task-item.color-blue::before { background: var(--color-blue); }
        .task-item.color-purple::before { background: var(--color-purple); }
        .task-item.color-pink::before { background: var(--color-pink); }
        .task-item.color-teal::before { background: var(--color-teal); }
        .task-item.color-indigo::before { background: var(--color-indigo); }
        
        .task-item.current-task { 
            border-color: var(--warning);
            box-shadow: 0 6px 25px rgba(247, 37, 133, 0.15);
            transform: scale(1.02);
            z-index: 1;
            animation: current-pulse 2s ease-in-out infinite;
        }
        @keyframes current-pulse {
            0%, 100% { box-shadow: 0 6px 25px rgba(247, 37, 133, 0.15); }
            50% { box-shadow: 0 8px 35px rgba(247, 37, 133, 0.25); }
        }
        .task-item.completed-task {
            opacity: 0.7;
            order: 999;
        }
        .task-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.07);
        }
        .task-item.current-task:hover {
            transform: scale(1.02) translateY(-3px);
        }
        /* æ»‘åŠ¨æ“ä½œæŒ‰é’® */
        .task-swipe-actions {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 0;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .task-item.show-actions .task-swipe-actions {
            transform: translateX(0);
        }
        .swipe-btn {
            width: 60px;
            height: 100%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: var(--transition);
        }
        .swipe-complete {
            background: var(--success);
            color: white;
        }
        .swipe-edit {
            background: var(--primary);
            color: white;
        }
        .swipe-delete {
            background: var(--warning);
            color: white;
            border-radius: 0 var(--radius) var(--radius) 0;
        }
        .task-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--success);
            transition: var(--transition);
            flex-shrink: 0;
            position: relative;
        }
        .task-checkbox::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 28px;
            height: 28px;
            background: rgba(63, 55, 201, 0.1);
            border-radius: 50%;
            transition: var(--transition);
        }
        .task-checkbox:checked::after {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }
        .task-checkbox:checked {
            transform: scale(1.1);
        }
        .task-info {
            flex: 1;
            min-width: 0;
        }
        .task-name { 
            color: var(--dark);
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 4px;
            transition: var(--transition);
            word-break: break-word;
        }
        .task-checkbox:checked + .task-info .task-name {
            text-decoration: line-through;
            color: var(--gray);
            opacity: 0.8;
        }
        .task-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: var(--gray);
            flex-wrap: wrap;
        }
        .task-time, .task-category {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .task-category {
            padding: 2px 8px;
            border-radius: 12px;
            background: var(--light);
        }
        .priority-high { background: rgba(229, 62, 62, 0.1); color: #e53e3e; }
        .priority-medium { background: rgba(237, 137, 54, 0.1); color: #ed8936; }
        .priority-low { background: rgba(72, 187, 120, 0.1); color: #48bb78; }
        .task-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        @media (max-width: 768px) {
            .task-actions {
                display: none;
            }
        }
        .task-edit, .task-delete {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
        }
        .task-edit { color: var(--primary); }
        .task-delete { color: var(--warning); }
        .task-edit:hover { color: #3a56d4; transform: scale(1.1); }
        .task-delete:hover { color: #d91c68; transform: scale(1.1); }
        .complete-animation { 
            position: absolute; 
            top: 50%; 
            right: 20px; 
            transform: translateY(-50%) scale(0);
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, rgba(63, 55, 201, 0.3) 0%, rgba(63, 55, 201, 0) 70%);
            border-radius: 50%;
            animation: complete 0.6s ease-out;
            z-index: 0;
        }
        @keyframes complete {
            0% { transform: translateY(-50%) scale(0); opacity: 1; }
            70% { transform: translateY(-50%) scale(1.5); opacity: 0.7; }
            100% { transform: translateY(-50%) scale(2); opacity: 0; }
        }
        /* ç¯å½¢è¿›åº¦å›¾ */
        .progress-section {
            background: var(--light);
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .progress-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--dark);
        }
        .progress-stats {
            color: var(--primary);
            font-weight: 500;
        }
        .progress-circle-container {
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .progress-circle-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
        }
        .progress-circle-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .progress-circle-bg {
            fill: none;
            stroke: #e2e8f0;
            stroke-width: 8;
        }
        .progress-circle-fill {
            fill: none;
            stroke: url(#gradient);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }
        .progress-circle-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .progress-percentage {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }
        .progress-label {
            font-size: 12px;
            color: var(--gray);
            margin-top: 4px;
        }
        .progress-details {
            flex: 1;
            min-width: 200px;
        }
        .progress-bar { 
            height: 8px; 
            background: white; 
            border-radius: 4px; 
            margin: 15px 0; 
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .progress { 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 4px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* è¿ç»­æ‰“å¡å¾½ç«  */
        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #744210;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
            animation: shine 2s ease-in-out infinite;
        }
        @keyframes shine {
            0%, 100% { box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5); }
        }
        .btn-group { 
            text-align: center; 
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .btn { 
            padding: 11px 32px; 
            border: none; 
            border-radius: 30px; 
            cursor: pointer; 
            font-size: 15px; 
            transition: var(--transition);
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-width: 150px;
        }
        .btn-save { 
            background: var(--primary); 
            color: white; 
        }
        .btn-save:hover { 
            background: #3a56d4; 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.2);
        }
        .btn-reset { 
            background: white; 
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        .btn-reset:hover { 
            background: rgba(247, 37, 133, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(247, 37, 133, 0.1);
        }
        .btn-export {
            background: white;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        .btn-export:hover {
            background: rgba(67, 97, 238, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.1);
        }
        .history-list { 
            max-height: 450px; 
            overflow-y: auto;
            padding-right: 10px;
        }
        .history-list::-webkit-scrollbar {
            width: 6px;
        }
        .history-list::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 3px;
        }
        .history-list::-webkit-scrollbar-thumb {
            background: var(--light-gray);
            border-radius: 3px;
        }
        .history-list::-webkit-scrollbar-thumb:hover {
            background: var(--gray);
        }
        .history-item { 
            padding: 18px; 
            border-bottom: 1px solid var(--light-gray); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            transition: var(--transition);
            border-radius: var(--radius);
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .history-item:hover { 
            background: var(--light);
            transform: translateX(5px);
        }
        .history-date { 
            font-weight: 600; 
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .history-date-icon {
            color: var(--primary);
            font-size: 14px;
        }
        .history-status { 
            padding: 6px 16px; 
            border-radius: 20px; 
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }
        .status-complete { 
            background: rgba(63, 55, 201, 0.1); 
            color: var(--success); 
        }
        .status-partial { 
            background: rgba(247, 37, 133, 0.1); 
            color: var(--warning); 
        }
        .status-incomplete { 
            background: rgba(108, 117, 125, 0.1); 
            color: var(--gray); 
        }
        .auto-save-notice {
            text-align: center;
            font-size: 13px;
            color: var(--gray);
            margin-top: 15px;
        }
        .auto-save-icon {
            color: var(--success);
            margin-right: 5px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: translateY(-20px);
            transition: var(--transition);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal.active .modal-content {
            transform: translateY(0);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-gray);
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
            z-index: 1001;
            position: relative;
        }
        .modal-close:hover {
            color: var(--warning);
            transform: rotate(90deg);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .form-col {
            flex: 1;
        }
        .color-options {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .color-option.active {
            border-color: var(--dark);
            transform: scale(1.2);
        }
        .color-red { background: #e53e3e; }
        .color-orange { background: #ed8936; }
        .color-green { background: #48bb78; }
        .color-blue { background: #4299e1; }
        .color-purple { background: #9f7aea; }
        .color-pink { background: #ec4899; }
        .color-teal { background: #14b8a6; }
        .color-indigo { background: #6366f1; }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        .btn-cancel {
            background: white;
            color: var(--gray);
            border: 1px solid var(--light-gray);
        }
        .btn-cancel:hover {
            background: var(--light);
        }
        .btn-confirm {
            background: var(--success);
            color: white;
        }
        .btn-confirm:hover {
            background: #342da3;
        }
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            line-height: 1;
            text-align: center;
        }
        /* æ¿€æ´»ç æ¨¡æ€æ¡†æ ·å¼ */
        .activation-modal .modal-content {
            max-width: 450px;
        }
        .activation-form .form-input {
            letter-spacing: 2px;
            text-align: center;
            font-size: 16px;
        }
        .activation-hint {
            text-align: center;
            font-size: 13px;
            color: var(--gray);
            margin-top: -15px;
            margin-bottom: 20px;
        }
        .activation-error {
            color: var(--warning);
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
            height: 18px;
        }
        /* è¯•ç”¨æ¨¡å¼æç¤º */
        .trial-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--warning), #ff6b9d);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            z-index: 100;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(247, 37, 133, 0.3);
            animation: pulse-badge 2s ease-in-out infinite;
        }
        .trial-limit-modal .modal-content {
            max-width: 400px;
            text-align: center;
        }
        .trial-count {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary);
            margin: 20px 0;
        }
        /* å†²çªæç¤º */
        .conflict-warning {
            background: rgba(229, 62, 62, 0.1);
            border: 1px solid rgba(229, 62, 62, 0.3);
            color: #e53e3e;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        .conflict-warning.show {
            display: block;
            animation: shake 0.5s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        /* é•¿æŒ‰èœå• */
        .long-press-menu {
            position: fixed;
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 8px 0;
            z-index: 2000;
            display: none;
            min-width: 150px;
        }
        .long-press-menu.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .menu-item:hover {
            background: var(--light);
        }
        .menu-item.delete {
            color: var(--warning);
        }
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            h1 {
                font-size: 24px;
            }
            .header-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .task-list {
                grid-template-columns: 1fr;
            }
            .btn {
                padding: 10px 20px;
                margin: 0 5px 10px;
                min-width: 120px;
                font-size: 14px;
            }
            .current-task-card {
                padding: 15px;
                font-size: 14px;
            }
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            .progress-circle-container {
                flex-direction: column;
                gap: 20px;
            }
        }
        @media (max-width: 480px) {
            .date-time {
                flex-direction: column;
                align-items: flex-start;
            }
            .task-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            .trial-badge {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨æ¨ªå¹…é€šçŸ¥ -->
    <div class="top-banner" id="top-banner">
        <span id="banner-text"></span>
        <button class="banner-action" id="banner-action" style="display:none;"></button>
        <button class="banner-close" id="banner-close">âœ•</button>
    </div>

    <!-- è¯•ç”¨æ¨¡å¼å¾½ç«  -->
    <div class="trial-badge" id="trial-badge" style="display:none;">
        è¯•ç”¨æ¨¡å¼ (<span id="trial-count">3</span>)
    </div>

    <div class="container" style="margin-top: 50px;">
        <h1>ç®€Â·æ‰“å¡</h1>
        <div class="subtitle">HXZXS å¼€å‘ # v.1.26w # è¯•è¯•å·¦æ»‘/é•¿æŒ‰ä»»åŠ¡å¡ç‰‡</div>
        
        <div class="header-bar">
            <div class="date-time">
                <div class="date-box">
                    <span class="date-icon icon">ğŸ“…</span>
                    <span id="current-date">2024-01-01</span>
                </div>
                <div class="time-box">
                    <span class="time-icon icon">â°</span>
                    <span id="current-time">00:00:00</span>
                </div>
            </div>
            <button class="add-task-btn" id="add-task-btn">
                <span class="icon">â•</span> æ·»åŠ æ–°ä»»åŠ¡
            </button>
        </div>
        
        <div class="current-task-card" id="current-task-card">
            <span class="task-icon icon">ğŸ’¡</span>
            <div class="current-task-text">
                <div id="current-task-line">
                    å½“å‰æ—¶æ®µæ¨èä»»åŠ¡ï¼š<span class="task-name-highlight" id="current-task-name">æ£€æµ‹ä¸­...</span>
                    <span class="countdown-badge" id="countdown-badge" style="display:none;"></span>
                </div>
                <div class="free-time-suggestions" id="free-time-suggestions" style="display:none;">
                    <span class="suggestion-tag">ğŸ“š é€‚åˆå¤ä¹ </span>
                    <span class="suggestion-tag">ğŸ“ æ•´ç†ç¬”è®°</span>
                    <span class="suggestion-tag">ğŸ§˜ çŸ­æš‚ä¼‘æ¯</span>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="today">ä»Šæ—¥æ‰“å¡</div>
            <div class="tab" data-tab="history">å†å²è®°å½•</div>
        </div>
        
        <!-- ä»Šæ—¥æ‰“å¡å†…å®¹ -->
        <div class="tab-content active" id="today-content">
            <div class="task-list" id="task-container">
                <!-- ä»»åŠ¡é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="progress-section">
                <div class="progress-header">
                    <div style="display:flex;align-items:center;">
                        <div class="progress-title">å­¦ä¹ å®Œæˆè¿›åº¦</div>
                        <div class="streak-badge" id="streak-badge" style="display:none;">
                            ğŸ”¥ <span id="streak-days">0</span>å¤©
                        </div>
                    </div>
                    <div class="progress-stats" id="progress-stats">0/0 ä»»åŠ¡å®Œæˆ</div>
                </div>
                <div class="progress-circle-container">
                    <div class="progress-circle-wrapper">
                        <svg class="progress-circle-svg" viewBox="0 0 100 100">
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:var(--primary)" />
                                    <stop offset="100%" style="stop-color:var(--success)" />
                                </linearGradient>
                            </defs>
                            <circle class="progress-circle-bg" cx="50" cy="50" r="42"/>
                            <circle class="progress-circle-fill" id="progress-circle" cx="50" cy="50" r="42"
                                stroke-dasharray="264" stroke-dashoffset="264"/>
                        </svg>
                        <div class="progress-circle-text">
                            <div class="progress-percentage" id="progress-percentage">0%</div>
                            <div class="progress-label">å®Œæˆç‡</div>
                        </div>
                    </div>
                    <div class="progress-details" style="flex:1;min-width:250px;">
                        <div class="progress-bar">
                            <div class="progress" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <div style="text-align: right; font-size: 14px; color: var(--gray);margin-bottom:15px;">
                            å·²å®Œæˆ: <span id="progress-text">0%</span>
                        </div>
                        <div style="font-size:13px;color:var(--gray);line-height:1.6;">
                            ğŸ’¡ <span id="progress-hint">å¼€å§‹æ·»åŠ ä»»åŠ¡ï¼Œå¼€å¯é«˜æ•ˆå­¦ä¹ çš„ä¸€å¤©ï¼</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-save" id="save-btn">æ‰‹åŠ¨ä¿å­˜æ‰“å¡</button>
                <button class="btn btn-reset" id="reset-btn">é‡ç½®ä»Šæ—¥ä»»åŠ¡</button>
                <button class="btn btn-export" id="export-btn">å¯¼å‡ºæ•°æ®</button>
            </div>
            <div class="auto-save-notice">
                <span class="auto-save-icon icon">â˜†</span>è‡ªåŠ¨ä¿å­˜åŠŸèƒ½å·²å¼€å¯ï¼Œæ— éœ€é¢‘ç¹æ‰‹åŠ¨ä¿å­˜ âš  è¯·å‹¿åˆ é™¤ç½‘é¡µcookieã€ç«™ç‚¹æ•°æ®åŠå…¶ä»–æ•°æ®
            </div>
        </div>
        
        <!-- å†å²è®°å½•å†…å®¹ -->
        <div class="tab-content" id="history-content">
            <div class="history-list" id="history-container">
                <!-- å†å²è®°å½•å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">æ·»åŠ æ–°ä»»åŠ¡</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="conflict-warning" id="conflict-warning">
                âš ï¸ è¯¥æ—¶æ®µå·²æœ‰ä»»åŠ¡ã€Œ<span id="conflict-task-name"></span>ã€ï¼Œæ˜¯å¦ç»§ç»­æ·»åŠ ï¼Ÿ
            </div>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label class="form-label" for="task-name">ä»»åŠ¡åç§°</label>
                    <input type="text" class="form-input" id="task-name" placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°" required>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label class="form-label" for="task-time">å¤‡æ³¨</label>
                        <input type="text" class="form-input" id="task-time" placeholder="å…·ä½“æƒ…å†µ" required>
                    </div>
                    <div class="form-col">
                        <label class="form-label" for="task-priority">é‡è¦ç¨‹åº¦</label>
                        <select class="form-select" id="task-priority" required>
                            <option value="high">ğŸ¥‡ç´§æ€¥</option>
                            <option value="medium" selected>ğŸ¥ˆæ™®é€š</option>
                            <option value="low">ğŸ¥‰ä¸æ…Œ</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label class="form-label" for="task-start-time">å¼€å§‹æ—¶é—´</label>
                        <input type="time" class="form-input" id="task-start-time" required>
                    </div>
                    <div class="form-col">
                        <label class="form-label" for="task-end-time">ç»“æŸæ—¶é—´</label>
                        <input type="time" class="form-input" id="task-end-time" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">å¡ç‰‡é¢œè‰²</label>
                    <div class="color-options">
                        <div class="color-option color-red" data-color="red"></div>
                        <div class="color-option color-orange active" data-color="orange"></div>
                        <div class="color-option color-green" data-color="green"></div>
                        <div class="color-option color-blue" data-color="blue"></div>
                        <div class="color-option color-purple" data-color="purple"></div>
                        <div class="color-option color-pink" data-color="pink"></div>
                        <div class="color-option color-teal" data-color="teal"></div>
                        <div class="color-option color-indigo" data-color="indigo"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" id="btn-cancel">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ç¡®è®¤ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ¿€æ´»ç éªŒè¯æ¨¡æ€æ¡† -->
    <div class="modal activation-modal" id="activation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ¿€æ´»æ‰“å¡ç³»ç»Ÿ</h3>
                <button class="modal-close" id="activation-modal-close">&times;</button>
            </div>
            <div class="activation-form">
                <div class="form-group">
                    <label class="form-label" for="activation-code">è¯·è¾“å…¥æ¿€æ´»ç </label>
                    <input type="text" class="form-input" id="activation-code" placeholder="è¯·è¾“å…¥5ç»„å…±25ä½å­—ç¬¦çš„æ¿€æ´»ç " required>
                    <div class="activation-hint">æ¿€æ´»ç ä¸åˆ†å¤§å°å†™ï¼Œæ”¯æŒè‡ªåŠ¨å»é™¤ç©ºæ ¼</div>
                </div>
                <div class="activation-error" id="activation-error"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" id="activation-cancel">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-confirm" id="activation-submit">éªŒè¯æ¿€æ´»</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯•ç”¨é™åˆ¶æç¤ºæ¨¡æ€æ¡† -->
    <div class="modal trial-limit-modal" id="trial-limit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">è¯•ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™</h3>
                <button class="modal-close" id="trial-limit-close">&times;</button>
            </div>
            <div style="text-align:center;padding:20px 0;">
                <div style="font-size:64px;margin-bottom:15px;">ğŸ”’</div>
                <p style="color:var(--gray);margin-bottom:20px;line-height:1.6;">
                    æ‚¨å·²ä½¿ç”¨å®Œ3æ¬¡å…è´¹è¯•ç”¨æœºä¼š<br>
                    æ¿€æ´»åå¯æ°¸ä¹…ä½¿ç”¨å…¨éƒ¨åŠŸèƒ½
                </p>
                <button class="btn btn-confirm" id="trial-activate-btn" style="min-width:200px;">ç«‹å³æ¿€æ´»</button>
            </div>
        </div>
    </div>

    <!-- é•¿æŒ‰èœå• -->
    <div class="long-press-menu" id="long-press-menu">
        <div class="menu-item" id="menu-complete">
            <span>âœ“</span> æ ‡è®°å®Œæˆ
        </div>
        <div class="menu-item" id="menu-edit">
            <span>âœï¸</span> ç¼–è¾‘ä»»åŠ¡
        </div>
        <div class="menu-item delete" id="menu-delete">
            <span>ğŸ—‘ï¸</span> åˆ é™¤ä»»åŠ¡
        </div>
    </div>

    <script>
        // æ¿€æ´»ç é…ç½®
        const VALID_ACTIVATION_CODE = "TX9XD98N7V6WMQ6BX7FGH8Q99";
        const ACTIVATION_KEY = "checkInActivated";
        const TRIAL_COUNT_KEY = "checkInTrialCount";
        const MAX_TRIAL = 3;
        
        // æœ¬åœ°å­˜å‚¨å·¥å…·
        const StorageUtil = {
            set: function(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.error("æœ¬åœ°å­˜å‚¨å¤±è´¥:", e);
                }
            },
            get: function(key) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : null;
                } catch (e) {
                    console.error("è·å–æœ¬åœ°å­˜å‚¨å¤±è´¥:", e);
                    return null;
                }
            }
        };

        // ç¯å¢ƒæ£€æµ‹å·¥å…·
        const EnvDetector = {
            isIncognito: function() {
                try {
                    const testKey = 'incognito_test_' + Date.now();
                    localStorage.setItem(testKey, testKey);
                    localStorage.removeItem(testKey);
                    return false;
                } catch (e) {
                    return true;
                }
            },
            isWeChat: function() {
                const ua = window.navigator.userAgent.toLowerCase();
                return ua.includes('micromessenger') || (typeof wx !== 'undefined' && wx.miniprogram);
            },
            isDingTalk: function() {
                const ua = window.navigator.userAgent.toLowerCase();
                return ua.includes('dingtalk') || ua.includes('dingtalkbrowser');
            },
            checkRestrictedEnv: function() {
                return {
                    isRestricted: this.isIncognito() || this.isWeChat() || this.isDingTalk(),
                    type: this.isIncognito() ? 'æ— ç—•æµè§ˆ' : 
                          this.isWeChat() ? 'å¾®ä¿¡' : 
                          this.isDingTalk() ? 'é’‰é’‰æ²™ç›’' : ''
                };
            }
        };

        // å…¨å±€çŠ¶æ€
        let isActivated = StorageUtil.get(ACTIVATION_KEY) === true;
        let trialCount = StorageUtil.get(TRIAL_COUNT_KEY) || 0;
        let checkInData = StorageUtil.get('customCheckIn') || {};
        let currentEditTaskId = null;
        let longPressTimer = null;
        let currentTaskElement = null;

        // é¡µé¢åŠ è½½
        window.addEventListener('DOMContentLoaded', function() {
            const envCheck = EnvDetector.checkRestrictedEnv();
            
            // æ˜¾ç¤ºé¡¶éƒ¨æ¨ªå¹…ï¼ˆæ¸©å’Œæç¤ºï¼‰
            if (envCheck.isRestricted) {
                showBanner(
                    `æ£€æµ‹åˆ°${envCheck.type}ç¯å¢ƒï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œæ¨èä½¿ç”¨é»˜è®¤æµè§ˆå™¨è¿è¡Œ`,
                    'ä»è¦ç»§ç»­',
                    () => { hideBanner(); initApp(); },
                    'env-warning'
                );
            } else {
                initApp();
            }
            
            // ç»‘å®šæ¨ªå¹…å…³é—­
            document.getElementById('banner-close').addEventListener('click', hideBanner);
            
            // æ›´æ–°æ—¶é—´
            updateDateTime();
            setInterval(updateDateTime, 1000);
            setInterval(updateCountdown, 1000);
        });

        function initApp() {
            initActivationHandlers();
            
            if (isActivated) {
                initMainFunctions();
            } else {
                initTrialMode();
            }
        }

        // æ˜¾ç¤ºé¡¶éƒ¨æ¨ªå¹…
        function showBanner(text, actionText, actionCallback, type = '') {
            const banner = document.getElementById('top-banner');
            const bannerText = document.getElementById('banner-text');
            const bannerAction = document.getElementById('banner-action');
            
            bannerText.textContent = text;
            banner.className = 'top-banner show ' + type;
            
            if (actionText) {
                bannerAction.textContent = actionText;
                bannerAction.style.display = 'inline-block';
                bannerAction.onclick = actionCallback;
            } else {
                bannerAction.style.display = 'none';
            }
        }

        function hideBanner() {
            document.getElementById('top-banner').classList.remove('show');
        }

        // è¯•ç”¨æ¨¡å¼åˆå§‹åŒ–
        function initTrialMode() {
            updateTrialBadge();
            
            // æ˜¾ç¤ºæ¿€æ´»æ¨ªå¹…
            showBanner(
                'å½“å‰ä¸ºè¯•ç”¨æ¨¡å¼ï¼Œå‰©ä½™' + (MAX_TRIAL - trialCount) + 'æ¬¡æ“ä½œæœºä¼š',
                'ç«‹å³æ¿€æ´»',
                openActivationModal,
                'activation-banner'
            );
            
            // è¯•ç”¨å¾½ç« ç‚¹å‡»æ¿€æ´»
            document.getElementById('trial-badge').addEventListener('click', openActivationModal);
            
            initMainFunctions();
        }

        function updateTrialBadge() {
            const badge = document.getElementById('trial-badge');
            const count = document.getElementById('trial-count');
            if (!isActivated) {
                badge.style.display = 'block';
                count.textContent = MAX_TRIAL - trialCount;
            } else {
                badge.style.display = 'none';
            }
        }

        // æ£€æŸ¥è¯•ç”¨é™åˆ¶
        function checkTrialLimit() {
            if (isActivated) return true;
            if (trialCount >= MAX_TRIAL) {
                document.getElementById('trial-limit-modal').classList.add('active');
                return false;
            }
            return true;
        }

        function incrementTrial() {
            if (!isActivated) {
                trialCount++;
                StorageUtil.set(TRIAL_COUNT_KEY, trialCount);
                updateTrialBadge();
                
                if (trialCount >= MAX_TRIAL) {
                    document.getElementById('trial-limit-modal').classList.add('active');
                }
            }
        }

        // åˆå§‹åŒ–æ¿€æ´»ç›¸å…³
        function initActivationHandlers() {
            const activationModal = document.getElementById('activation-modal');
            const activationCodeInput = document.getElementById('activation-code');
            const activationSubmitBtn = document.getElementById('activation-submit');
            const activationCancelBtn = document.getElementById('activation-cancel');
            const activationCloseBtn = document.getElementById('activation-modal-close');
            const activationError = document.getElementById('activation-error');
            
            window.openActivationModal = function() {
                activationError.textContent = '';
                activationCodeInput.value = '';
                activationModal.classList.add('active');
                activationCodeInput.focus();
            };
            
            window.closeActivationModal = function() {
                activationModal.classList.remove('active');
            };
            
            activationCancelBtn.addEventListener('click', closeActivationModal);
            activationCloseBtn.addEventListener('click', closeActivationModal);
            
            activationModal.addEventListener('click', function(e) {
                if (e.target === activationModal) closeActivationModal();
            });
            
            activationSubmitBtn.addEventListener('click', function() {
                const code = activationCodeInput.value.trim();
                if (!code) {
                    activationError.textContent = 'è¯·è¾“å…¥æ¿€æ´»ç ';
                    return;
                }
                
                const formattedCode = code.replace(/\s+|-/g, '').toUpperCase();
                if (formattedCode === VALID_ACTIVATION_CODE) {
                    StorageUtil.set(ACTIVATION_KEY, true);
                    isActivated = true;
                    closeActivationModal();
                    hideBanner();
                    updateTrialBadge();
                    alert('æ¿€æ´»æˆåŠŸï¼å·²è§£é”å…¨éƒ¨åŠŸèƒ½ï½');
                    initMainFunctions();
                } else {
                    activationError.textContent = 'æ¿€æ´»ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥';
                    activationCodeInput.focus();
                }
            });
            
            activationCodeInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') activationSubmitBtn.click();
            });

            // è¯•ç”¨é™åˆ¶æ¨¡æ€æ¡†
            document.getElementById('trial-limit-close').addEventListener('click', function() {
                document.getElementById('trial-limit-modal').classList.remove('active');
            });
            document.getElementById('trial-activate-btn').addEventListener('click', function() {
                document.getElementById('trial-limit-modal').classList.remove('active');
                openActivationModal();
            });
        }

        // åˆå§‹åŒ–ä¸»åŠŸèƒ½
        function initMainFunctions() {
            const today = getCurrentDate();
            if (!checkInData[today]) {
                checkInData[today] = [];
                StorageUtil.set('customCheckIn', checkInData);
            }
            
            renderTodayTasks();
            initEventListeners();
            updateStreak();
            setInterval(renderTodayTasks, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°
        }

        function getCurrentDate() {
            const date = new Date();
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        }

        function getCurrentTime() {
            const date = new Date();
            return `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}:${date.getSeconds().toString().padStart(2,'0')}`;
        }

        function getSimpleTime() {
            const date = new Date();
            return `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
        }

        function updateDateTime() {
            document.getElementById("current-date").textContent = getCurrentDate();
            document.getElementById("current-time").textContent = getCurrentTime();
            updateCurrentTaskDisplay();
        }

        // æŸ¥æ‰¾å½“å‰ä»»åŠ¡
        function findCurrentTask() {
            const today = getCurrentDate();
            if (!checkInData[today]) return null;
            
            const currentTime = getSimpleTime();
            const current = checkInData[today].find(task => {
                const [start, end] = task.timeRange.split('-');
                return currentTime >= start && currentTime <= end && !task.completed;
            });
            
            // ä¹Ÿæ£€æŸ¥å·²å®Œæˆçš„ä»»åŠ¡ä½†è¿”å›ä¸åŒçŠ¶æ€
            const completedCurrent = checkInData[today].find(task => {
                const [start, end] = task.timeRange.split('-');
                return currentTime >= start && currentTime <= end && task.completed;
            });
            
            return current || (completedCurrent ? {...completedCurrent, isCompleted: true} : null);
        }

        // æ›´æ–°å½“å‰ä»»åŠ¡æ˜¾ç¤º
        function updateCurrentTaskDisplay() {
            const currentTask = findCurrentTask();
            const taskNameEl = document.getElementById("current-task-name");
            const taskTimeEl = document.getElementById("current-task-time");
            const countdownBadge = document.getElementById("countdown-badge");
            const suggestions = document.getElementById("free-time-suggestions");
            const card = document.getElementById("current-task-card");
            
            if (currentTask && !currentTask.isCompleted) {
                taskNameEl.textContent = currentTask.name;
                countdownBadge.style.display = 'inline-block';
                suggestions.style.display = 'none';
                card.classList.add('active-task');
                updateCountdown();
            } else if (currentTask && currentTask.isCompleted) {
                taskNameEl.textContent = currentTask.name + " (å·²å®Œæˆ)";
                countdownBadge.style.display = 'none';
                suggestions.style.display = 'none';
                card.classList.remove('active-task');
            } else {
                taskNameEl.textContent = "è‡ªç”±æ—¶é—´";
                countdownBadge.style.display = 'none';
                suggestions.style.display = 'flex';
                card.classList.remove('active-task');
            }
        }

        // æ›´æ–°å€’è®¡æ—¶
        function updateCountdown() {
            const currentTask = findCurrentTask();
            const badge = document.getElementById("countdown-badge");
            
            if (!currentTask || currentTask.isCompleted) {
                badge.style.display = 'none';
                return;
            }
            
            const currentTime = getSimpleTime();
            const [, end] = currentTask.timeRange.split('-');
            const [endHour, endMin] = end.split(':').map(Number);
            const [currHour, currMin] = currentTime.split(':').map(Number);
            
            const endMinutes = endHour * 60 + endMin;
            const currMinutes = currHour * 60 + currMin;
            const diff = endMinutes - currMinutes;
            
            if (diff > 0) {
                const hours = Math.floor(diff / 60);
                const mins = diff % 60;
                badge.textContent = `å‰©ä½™${hours > 0 ? hours + 'å°æ—¶' : ''}${mins}åˆ†é’Ÿ`;
            } else {
                badge.textContent = 'å³å°†ç»“æŸ';
            }
        }

        // æ™ºèƒ½æ’åºç®—æ³•
        function sortTasksIntelligently(tasks) {
            const currentTime = getSimpleTime();
            const currentTask = findCurrentTask();
            
            return tasks.sort((a, b) => {
                // å·²å®Œæˆä»»åŠ¡æ’åˆ°æœ€å
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                
                // å½“å‰è¿›è¡Œä¸­çš„ä»»åŠ¡ç½®é¡¶
                if (currentTask) {
                    if (a.id === currentTask.id) return -1;
                    if (b.id === currentTask.id) return 1;
                }
                
                // æŒ‰å¼€å§‹æ—¶é—´æ’åº
                const [aStart] = a.timeRange.split('-');
                const [bStart] = b.timeRange.split('-');
                return aStart.localeCompare(bStart);
            });
        }

        // æ¸²æŸ“ä»Šæ—¥ä»»åŠ¡
        function renderTodayTasks() {
            const today = getCurrentDate();
            const container = document.getElementById("task-container");
            container.innerHTML = "";
            
            if (!checkInData[today] || checkInData[today].length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px 0; color: var(--gray);">
                        <div style="font-size: 40px; margin-bottom: 15px; display: block;">ğŸ“</div>
                        æš‚æ— ä»»åŠ¡ï¼Œç‚¹å‡»"æ·»åŠ æ–°ä»»åŠ¡"åˆ›å»ºä»»åŠ¡ï¼Œå¼€å¯æ‰“å¡ä¹‹æ—…
                    </div>
                `;
                updateProgress();
                return;
            }
            
            const sortedTasks = sortTasksIntelligently([...checkInData[today]]);
            const currentTaskId = findCurrentTask()?.id;
            
            sortedTasks.forEach(task => {
                const isCurrentTask = task.id === currentTaskId && !task.completed;
                const priorityClass = getPriorityClass(task.priority);
                const priorityIcon = getPriorityIcon(task.priority);
                const priorityText = getPriorityText(task.priority);
                
                const taskItem = document.createElement("div");
                taskItem.className = `task-item color-${task.color} ${isCurrentTask ? 'current-task' : ''} ${task.completed ? 'completed-task' : ''}`;
                taskItem.dataset.taskId = task.id;
                
                taskItem.innerHTML = `
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} data-task-id="${task.id}">
                    <div class="task-info">
                        <div class="task-name">${task.name}</div>
                        <div class="task-meta">
                            <div class="task-time">â° ${task.timeRange} | ${task.time}</div>
                            <div class="task-category ${priorityClass}">${priorityIcon} ${priorityText}</div>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="task-edit" data-task-id="${task.id}" title="ç¼–è¾‘ä»»åŠ¡">âœï¸</button>
                        <button class="task-delete" data-task-id="${task.id}" title="åˆ é™¤ä»»åŠ¡">ğŸ—‘ï¸</button>
                    </div>
                    <div class="task-swipe-actions">
                        <button class="swipe-btn swipe-complete" data-task-id="${task.id}">âœ“</button>
                        <button class="swipe-btn swipe-edit" data-task-id="${task.id}">âœï¸</button>
                        <button class="swipe-btn swipe-delete" data-task-id="${task.id}">ğŸ—‘ï¸</button>
                    </div>
                `;
                
                // ç»‘å®šæ»‘åŠ¨æ‰‹åŠ¿
                bindSwipeGesture(taskItem, task.id);
                // ç»‘å®šé•¿æŒ‰èœå•
                bindLongPress(taskItem, task.id);
                
                container.appendChild(taskItem);
            });
            
            updateProgress();
            updateCurrentTaskDisplay();
        }

        // ç»‘å®šæ»‘åŠ¨æ‰‹åŠ¿
        function bindSwipeGesture(element, taskId) {
            let startX = 0;
            let currentX = 0;
            let isSwiping = false;
            
            element.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                isSwiping = true;
            }, {passive: true});
            
            element.addEventListener('touchmove', function(e) {
                if (!isSwiping) return;
                currentX = e.touches[0].clientX;
                const diff = startX - currentX;
                
                if (diff > 50) {
                    element.classList.add('show-actions');
                } else if (diff < -50) {
                    element.classList.remove('show-actions');
                }
            }, {passive: true});
            
            element.addEventListener('touchend', function() {
                isSwiping = false;
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­
            element.addEventListener('click', function(e) {
                if (e.target.closest('.task-swipe-actions')) {
                    const action = e.target.classList.contains('swipe-complete') ? 'complete' :
                                  e.target.classList.contains('swipe-edit') ? 'edit' : 'delete';
                    handleSwipeAction(taskId, action);
                    element.classList.remove('show-actions');
                } else if (!e.target.closest('.task-actions')) {
                    document.querySelectorAll('.task-item.show-actions').forEach(item => {
                        if (item !== element) item.classList.remove('show-actions');
                    });
                }
            });
        }

        function handleSwipeAction(taskId, action) {
            if (!checkTrialLimit() && action !== 'complete') return;
            
            const today = getCurrentDate();
            const task = checkInData[today].find(t => t.id === taskId);
            if (!task) return;
            
            if (action === 'complete') {
                toggleTaskComplete(taskId);
            } else if (action === 'edit') {
                incrementTrial();
                openTaskModal(task);
            } else if (action === 'delete') {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                    incrementTrial();
                    checkInData[today] = checkInData[today].filter(t => t.id !== taskId);
                    StorageUtil.set('customCheckIn', checkInData);
                    renderTodayTasks();
                }
            }
        }

        // ç»‘å®šé•¿æŒ‰èœå•
        function bindLongPress(element, taskId) {
            let timer = null;
            const menu = document.getElementById('long-press-menu');
            
            const startPress = function(e) {
                if (e.target.closest('.task-checkbox') || e.target.closest('.task-actions')) return;
                
                timer = setTimeout(() => {
                    currentTaskElement = element;
                    const rect = element.getBoundingClientRect();
                    menu.style.left = (e.clientX || e.touches[0].clientX) + 'px';
                    menu.style.top = (e.clientY || e.touches[0].clientY) + 'px';
                    menu.classList.add('show');
                    
                    // ç»‘å®šèœå•é¡¹
                    document.getElementById('menu-complete').onclick = () => {
                        toggleTaskComplete(taskId);
                        menu.classList.remove('show');
                    };
                    document.getElementById('menu-edit').onclick = () => {
                        if (!checkTrialLimit()) return;
                        incrementTrial();
                        openTaskModal(checkInData[getCurrentDate()].find(t => t.id === taskId));
                        menu.classList.remove('show');
                    };
                    document.getElementById('menu-delete').onclick = () => {
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                            incrementTrial();
                            checkInData[getCurrentDate()] = checkInData[getCurrentDate()].filter(t => t.id !== taskId);
                            StorageUtil.set('customCheckIn', checkInData);
                            renderTodayTasks();
                        }
                        menu.classList.remove('show');
                    };
                }, 500);
            };
            
            const cancelPress = function() {
                if (timer) {
                    clearTimeout(timer);
                    timer = null;
                }
            };
            
            element.addEventListener('mousedown', startPress);
            element.addEventListener('touchstart', startPress, {passive: true});
            element.addEventListener('mouseup', cancelPress);
            element.addEventListener('mouseleave', cancelPress);
            element.addEventListener('touchend', cancelPress);
            element.addEventListener('touchmove', cancelPress);
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.long-press-menu')) {
                document.getElementById('long-press-menu').classList.remove('show');
            }
        });

        function toggleTaskComplete(taskId) {
            const today = getCurrentDate();
            const taskIndex = checkInData[today].findIndex(task => task.id === taskId);
            
            if (taskIndex !== -1) {
                checkInData[today][taskIndex].completed = !checkInData[today][taskIndex].completed;
                StorageUtil.set('customCheckIn', checkInData);
                renderTodayTasks();
                
                if (checkInData[today][taskIndex].completed) {
                    const element = document.querySelector(`[data-task-id="${taskId}"]`).closest('.task-item');
                    addCompleteAnimation(element);
                }
            }
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'high': return 'priority-high';
                case 'medium': return 'priority-medium';
                case 'low': return 'priority-low';
                default: return 'priority-medium';
            }
        }

        function getPriorityIcon(priority) {
            switch(priority) {
                case 'high': return 'ğŸ”´';
                case 'medium': return 'ğŸŸ ';
                case 'low': return 'ğŸŸ¢';
                default: return 'ğŸŸ ';
            }
        }

        function getPriorityText(priority) {
            switch(priority) {
                case 'high': return 'ğŸ¥‡ç´§æ€¥';
                case 'medium': return 'ğŸ¥ˆæ™®é€š';
                case 'low': return 'ğŸ¥‰ä¸æ…Œ';
                default: return 'ğŸ¥ˆæ™®é€š';
            }
        }

        // æ›´æ–°è¿›åº¦ï¼ˆç¯å½¢+æ¡å½¢ï¼‰
        function updateProgress() {
            const today = getCurrentDate();
            if (!checkInData[today]) {
                setProgress(0, 0);
                return;
            }
            
            const total = checkInData[today].length;
            const completed = checkInData[today].filter(task => task.completed).length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            setProgress(progress, completed, total);
            
            // æ›´æ–°æç¤ºè¯­
            const hint = document.getElementById('progress-hint');
            if (progress === 0) hint.textContent = 'å¼€å§‹æ·»åŠ ä»»åŠ¡ï¼Œå¼€å¯é«˜æ•ˆå­¦ä¹ çš„ä¸€å¤©ï¼';
            else if (progress < 50) hint.textContent = 'è‰¯å¥½çš„å¼€å§‹ï¼Œç»§ç»­ä¿æŒï¼';
            else if (progress < 100) hint.textContent = 'å·²ç»å®Œæˆå¤§åŠäº†ï¼ŒåŠ æ²¹ï¼';
            else hint.textContent = 'å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å…¨éƒ¨å®Œæˆ ğŸ‰';
        }

        function setProgress(percentage, completed, total) {
            // ç¯å½¢è¿›åº¦
            const circle = document.getElementById('progress-circle');
            const radius = 42;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            document.getElementById('progress-percentage').textContent = percentage + '%';
            
            // æ¡å½¢è¿›åº¦
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = percentage + '%';
            document.getElementById('progress-stats').textContent = `${completed}/${total} ä»»åŠ¡å®Œæˆ`;
        }

        // è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
        function updateStreak() {
            const dates = Object.keys(checkInData).sort();
            if (dates.length === 0) return;
            
            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = formatDateKey(checkDate);
                
                if (checkInData[dateStr] && checkInData[dateStr].some(t => t.completed)) {
                    streak++;
                } else if (i > 0) {
                    break;
                }
            }
            
            if (streak > 0) {
                document.getElementById('streak-badge').style.display = 'inline-flex';
                document.getElementById('streak-days').textContent = streak;
            }
        }

        function formatDateKey(date) {
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // æ·»åŠ ä»»åŠ¡æŒ‰é’®
            document.getElementById('add-task-btn').addEventListener('click', function() {
                if (!checkTrialLimit()) return;
                incrementTrial();
                openTaskModal();
            });
            
            // ä»»åŠ¡å¤é€‰æ¡†äº‹ä»¶ï¼ˆå§”æ‰˜ï¼‰
            document.getElementById('task-container').addEventListener('change', function(e) {
                if (e.target.classList.contains('task-checkbox')) {
                    const taskId = e.target.getAttribute('data-task-id');
                    toggleTaskComplete(taskId);
                }
            });
            
            // ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®ï¼ˆå§”æ‰˜ï¼‰
            document.getElementById('task-container').addEventListener('click', function(e) {
                const taskId = e.target.getAttribute('data-task-id');
                if (!taskId) return;
                
                if (e.target.classList.contains('task-edit')) {
                    if (!checkTrialLimit()) return;
                    incrementTrial();
                    const today = getCurrentDate();
                    const task = checkInData[today].find(t => t.id === taskId);
                    if (task) openTaskModal(task);
                } else if (e.target.classList.contains('task-delete')) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                        incrementTrial();
                        const today = getCurrentDate();
                        checkInData[today] = checkInData[today].filter(t => t.id !== taskId);
                        StorageUtil.set('customCheckIn', checkInData);
                        renderTodayTasks();
                    }
                }
            });
            
            // ä¿å­˜æŒ‰é’®
            document.getElementById('save-btn').addEventListener('click', function() {
                StorageUtil.set('customCheckIn', checkInData);
                const btn = this;
                const originalText = btn.textContent;
                btn.textContent = 'ä¿å­˜æˆåŠŸ âœ“';
                btn.style.background = '#3f37c9';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 1500);
            });
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('reset-btn').addEventListener('click', function() {
                const today = getCurrentDate();
                if (!checkInData[today] || checkInData[today].length === 0) {
                    alert('æš‚æ— ä»»åŠ¡å¯é‡ç½®ï¼');
                    return;
                }
                
                if (confirm('ç¡®å®šè¦é‡ç½®ä»Šæ—¥æ‰€æœ‰æ‰“å¡è®°å½•å—ï¼Ÿ')) {
                    checkInData[today] = checkInData[today].map(task => ({ ...task, completed: false }));
                    StorageUtil.set('customCheckIn', checkInData);
                    renderTodayTasks();
                }
            });
            
            // å¯¼å‡ºæŒ‰é’®
            document.getElementById('export-btn').addEventListener('click', exportData);
            
            // æ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-content`).classList.add('active');
                    
                    if (tabId === 'history') renderHistory();
                });
            });
            
            initTaskModalHandlers();
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(checkInData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ‰“å¡æ•°æ®_${getCurrentDate()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ä»»åŠ¡æ¨¡æ€æ¡†å¤„ç†
        function initTaskModalHandlers() {
            const taskModal = document.getElementById('task-modal');
            const taskForm = document.getElementById('task-form');
            const taskCloseBtn = document.getElementById('modal-close');
            const taskCancelBtn = document.getElementById('btn-cancel');
            
            window.openTaskModal = function(task = null) {
                const modalTitle = document.getElementById('modal-title');
                const taskIdInput = document.getElementById('task-id');
                const taskNameInput = document.getElementById('task-name');
                const taskTimeInput = document.getElementById('task-time');
                const taskPriorityInput = document.getElementById('task-priority');
                const taskStartTimeInput = document.getElementById('task-start-time');
                const taskEndTimeInput = document.getElementById('task-end-time');
                const colorOptions = document.querySelectorAll('.color-option');
                const conflictWarning = document.getElementById('conflict-warning');
                
                taskForm.reset();
                colorOptions.forEach(opt => opt.classList.remove('active'));
                colorOptions[1].classList.add('active');
                conflictWarning.classList.remove('show');
                currentEditTaskId = null;
                
                if (task) {
                    modalTitle.textContent = 'ç¼–è¾‘ä»»åŠ¡';
                    currentEditTaskId = task.id;
                    taskIdInput.value = task.id;
                    taskNameInput.value = task.name;
                    taskTimeInput.value = task.time;
                    taskPriorityInput.value = task.priority;
                    
                    const [start, end] = task.timeRange.split('-');
                    taskStartTimeInput.value = start;
                    taskEndTimeInput.value = end;
                    
                    colorOptions.forEach(opt => {
                        if (opt.dataset.color === task.color) opt.classList.add('active');
                    });
                } else {
                    modalTitle.textContent = 'æ·»åŠ æ–°ä»»åŠ¡';
                    const now = new Date();
                    const defaultStart = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                    const endTime = new Date(now.getTime() + 30 * 60000);
                    const defaultEnd = `${endTime.getHours().toString().padStart(2,'0')}:${endTime.getMinutes().toString().padStart(2,'0')}`;
                    
                    taskStartTimeInput.value = defaultStart;
                    taskEndTimeInput.value = defaultEnd;
                    taskTimeInput.value = '30åˆ†é’Ÿ';
                }
                
                taskModal.classList.add('active');
                taskNameInput.focus();
            };
            
            window.closeTaskModal = function() {
                taskModal.classList.remove('active');
            };
            
            taskCloseBtn.addEventListener('click', closeTaskModal);
            taskCancelBtn.addEventListener('click', closeTaskModal);
            
            taskModal.addEventListener('click', function(e) {
                if (e.target === taskModal) closeTaskModal();
            });
            
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // æ—¶é—´å˜åŒ–æ—¶æ£€æµ‹å†²çª
            document.getElementById('task-start-time').addEventListener('change', checkTimeConflict);
            document.getElementById('task-end-time').addEventListener('change', checkTimeConflict);
            
            taskForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const taskName = document.getElementById('task-name').value.trim();
                const taskTime = document.getElementById('task-time').value.trim();
                const taskPriority = document.getElementById('task-priority').value;
                const taskStartTime = document.getElementById('task-start-time').value;
                const taskEndTime = document.getElementById('task-end-time').value;
                const selectedColor = document.querySelector('.color-option.active').dataset.color;
                
                if (taskStartTime >= taskEndTime) {
                    alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´ï¼');
                    return;
                }
                
                // æ£€æŸ¥å†²çª
                const conflict = findTimeConflict(taskStartTime, taskEndTime, currentEditTaskId);
                if (conflict && !document.getElementById('conflict-warning').classList.contains('confirmed')) {
                    document.getElementById('conflict-task-name').textContent = conflict.name;
                    document.getElementById('conflict-warning').classList.add('show');
                    document.getElementById('conflict-warning').classList.add('confirmed');
                    return;
                }
                
                const taskData = {
                    name: taskName,
                    time: taskTime,
                    priority: taskPriority,
                    timeRange: `${taskStartTime}-${taskEndTime}`,
                    color: selectedColor
                };
                
                saveTask(taskData);
                document.getElementById('conflict-warning').classList.remove('confirmed');
            });
        }

        // æ£€æŸ¥æ—¶é—´å†²çª
        function checkTimeConflict() {
            const start = document.getElementById('task-start-time').value;
            const end = document.getElementById('task-end-time').value;
            if (!start || !end) return;
            
            const conflict = findTimeConflict(start, end, currentEditTaskId);
            const warning = document.getElementById('conflict-warning');
            
            if (conflict) {
                document.getElementById('conflict-task-name').textContent = conflict.name;
                warning.classList.add('show');
            } else {
                warning.classList.remove('show');
            }
        }

        function findTimeConflict(start, end, excludeId) {
            const today = getCurrentDate();
            if (!checkInData[today]) return null;
            
            return checkInData[today].find(task => {
                if (task.id === excludeId) return false;
                const [taskStart, taskEnd] = task.timeRange.split('-');
                return (start < taskEnd && end > taskStart);
            });
        }

        function saveTask(taskData) {
            const today = getCurrentDate();
            if (!checkInData[today]) checkInData[today] = [];
            
            if (currentEditTaskId) {
                const taskIndex = checkInData[today].findIndex(task => task.id === currentEditTaskId);
                if (taskIndex !== -1) {
                    checkInData[today][taskIndex] = { ...checkInData[today][taskIndex], ...taskData };
                }
            } else {
                const newTask = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                    completed: false,
                    ...taskData
                };
                checkInData[today].push(newTask);
            }
            
            StorageUtil.set('customCheckIn', checkInData);
            renderTodayTasks();
            closeTaskModal();
        }

        function addCompleteAnimation(element) {
            const animationEl = document.createElement("div");
            animationEl.className = "complete-animation";
            element.appendChild(animationEl);
            setTimeout(() => animationEl.remove(), 600);
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            const container = document.getElementById("history-container");
            container.innerHTML = "";
            const dates = Object.keys(checkInData).sort((a, b) => new Date(b) - new Date(a));
            
            if (dates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px 0; color: var(--gray);">
                        <div style="font-size: 40px; margin-bottom: 15px; display: block;">ğŸ“œ</div>
                        æš‚æ— æ‰“å¡å†å²è®°å½•
                    </div>
                `;
                return;
            }
            
            dates.forEach(date => {
                const tasks = checkInData[date];
                const total = tasks.length;
                const completed = tasks.filter(t => t.completed).length;
                let status, statusClass;
                
                if (completed === total && total > 0) {
                    status = "å…¨éƒ¨å®Œæˆ";
                    statusClass = "status-complete";
                } else if (completed > 0) {
                    status = `éƒ¨åˆ†å®Œæˆ(${completed}/${total})`;
                    statusClass = "status-partial";
                } else {
                    status = "æœªå®Œæˆ";
                    statusClass = "status-incomplete";
                }
                
                const historyItem = document.createElement("div");
                historyItem.className = "history-item";
                historyItem.innerHTML = `
                    <div class="history-date">
                        <span class="history-date-icon icon">ğŸ“…</span>
                        ${formatDisplayDate(date)}
                    </div>
                    <div class="history-status ${statusClass}">${status}</div>
                `;
                container.appendChild(historyItem);
            });
        }

        function formatDisplayDate(dateStr) {
            try {
                const date = new Date(dateStr);
                const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekDay = weekDays[date.getDay()];
                return `${month}æœˆ${day}æ—¥ æ˜ŸæœŸ${weekDay}`;
            } catch (e) {
                return dateStr;
            }
        }
    </script>
</body>
</html>

